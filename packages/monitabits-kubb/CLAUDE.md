# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with the Monitabits Kubb package.

**IMPORTANT: Always refer to `.cursor/rules/` for development standards.**

## Package Overview

**@repo/monitabits-kubb** generates TypeScript types, SWR hooks, server functions, and Zod schemas from the OpenAPI specification using Kubb. This package is automatically regenerated when the API starts in development mode.

## Essential Commands

```bash
bun run kubb        # Manually regenerate from openapi.yaml
bun run check:types # Run TypeScript type checking
bun run check       # Run Biome linter/formatter
```

## How It Works

1. **API starts in dev mode** (`apps/monitabits-api`)
2. **OpenAPI spec generated** from NestJS `@ApiProperty` decorators
3. **Written to** `src/openapi.yaml`
4. **Kubb runs automatically** and regenerates `src/gen/`

## Package Structure

```
packages/monitabits-kubb/
├── kubb.config.ts          # Kubb code generation config
├── src/
│   ├── openapi.yaml        # OpenAPI spec (auto-generated by API)
│   ├── mutator.server.ts   # Server-side HTTP client (Server Components, Server Actions)
│   ├── mutator.client.ts   # Client-side HTTP client with SWR (Client Components)
│   ├── mutator.d.ts        # Type declarations
│   ├── client.ts           # Client entry point
│   ├── server.ts           # Server entry point
│   └── gen/                # Generated code (do not edit)
│       ├── types/          # TypeScript type definitions
│       ├── hooks/          # SWR hooks for client-side data fetching
│       ├── server/         # Server functions for Server Components
│       ├── zod/            # Zod validation schemas
│       └── schemas/        # JSON schemas
└── package.json
```

## Package Exports

```typescript
"./mutator.client" → src/mutator.client.ts  // Client-side fetching with SWR
"./mutator.server" → src/mutator.server.ts  // Server-side fetching
"./hooks"          → src/gen/hooks/index.ts // SWR hooks (Client Components)
"./server"         → src/gen/server/index.ts // Server functions (Server Components)
"./types"          → src/gen/types/index.ts // TypeScript types
"./zod"            → src/gen/zod/index.ts   // Zod schemas
```

## Usage Patterns

### Server Components (Recommended)

Use server functions for Server Components and Server Actions:

```typescript
// In a Server Component or Server Action
import { 
  sessionsControllerGetCurrentSession,
  statisticsControllerGetSummary 
} from '@repo/monitabits-kubb/server';

// Server Component
async function DashboardPage() {
  // Pass headers with device ID for authentication
  const headers = { 'X-Device-Id': getDeviceId() };
  const data = await sessionsControllerGetCurrentSession({ headers });
  const stats = await statisticsControllerGetSummary({ headers });
  
  return (
    <div>
      <SessionDisplay session={data.session} />
      <StatsDisplay stats={stats} />
    </div>
  );
}
```

### Client Components

Use SWR hooks for Client Components with real-time updates:

```typescript
'use client';

import { useSessionsControllerGetCurrentSession } from '@repo/monitabits-kubb/hooks';

function SessionClient() {
  const { data, error, isLoading, mutate } = useSessionsControllerGetCurrentSession();
  
  if (isLoading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  
  return (
    <div>
      <SessionDisplay session={data.session} />
      <button onClick={() => mutate()}>Refresh</button>
    </div>
  );
}
```

### Import Types

```typescript
import type { 
  SessionDto, 
  SettingsDto, 
  ActionDto,
  StatisticsSummaryDto 
} from '@repo/monitabits-kubb/types';
```

### Import Zod Schemas

```typescript
import { settingsDtoSchema, sessionDtoSchema } from '@repo/monitabits-kubb/zod';

// Validate data
const validatedSettings = settingsDtoSchema.parse(data);
```

## HTTP Client (Mutators)

### Server Mutator (`mutator.server.ts`)

Used by server functions. Automatically:
- Uses API base URL from environment (`API_BASE_URL`, `NEXT_PUBLIC_API_URL`)
- Adds `X-Client-Time` header (ISO-8601)
- Adds `X-Timezone-Offset` and `X-Timezone-Name` headers
- Accepts `X-Device-Id` via headers parameter (must be passed explicitly on server)

```typescript
// Server-side: Must pass device ID explicitly
const headers = { 'X-Device-Id': deviceId };
const data = await sessionsControllerGetCurrentSession({ headers });
```

### Client Mutator (`mutator.client.ts`)

Used by SWR hooks. Automatically:
- Reads device ID from cookies (`monitabits_device_id`)
- Uses public API URL from environment (`NEXT_PUBLIC_API_URL`)
- Adds time headers automatically
- Provides SWR configuration with retry and revalidation

```typescript
// Client-side: Device ID auto-injected from cookies
const { data } = useSessionsControllerGetCurrentSession();
```

## Available Endpoints

### Sessions Controller
- `useSessionsControllerGetCurrentSession` / `sessionsControllerGetCurrentSession`
- `useSessionsControllerCheckIn` / `sessionsControllerCheckIn`
- `useSessionsControllerCheckOut` / `sessionsControllerCheckOut`

### Settings Controller
- `useSettingsControllerGetSettings` / `settingsControllerGetSettings`
- `useSettingsControllerUpdateSettings` / `settingsControllerUpdateSettings`

### Statistics Controller
- `useStatisticsControllerGetSummary` / `statisticsControllerGetSummary`
- `useStatisticsControllerGetDetails` / `statisticsControllerGetDetails`
- `useStatisticsControllerGetLockdownNow` / `statisticsControllerGetLockdownNow`

### Actions Controller
- `useActionsControllerCheat` / `actionsControllerCheat`
- `useActionsControllerHarm` / `actionsControllerHarm`
- `useActionsControllerGetPendingFollowUp` / `actionsControllerGetPendingFollowUp`
- `useActionsControllerSubmitFollowUp` / `actionsControllerSubmitFollowUp`

### Health Controller
- `useAppControllerGetStatus` / `appControllerGetStatus`

## Development Notes

- **Never edit generated files** - They are overwritten on each generation
- **Source of truth** is the API's `@ApiProperty` decorators
- **Regeneration happens automatically** when API starts in dev mode
- **Manual regeneration**: Run `bun run kubb` if needed
- **Server functions** for Server Components - better performance, SEO
- **SWR hooks** for Client Components - real-time updates, caching

## Related Documentation

- **[apps/monitabits-api/CLAUDE.md](../../apps/monitabits-api/CLAUDE.md)** - API with DTOs and OpenAPI generation
- **[apps/monitabits-swagger/README.md](../../apps/monitabits-swagger/README.md)** - Swagger UI documentation
